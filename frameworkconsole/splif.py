import os
import sys
import time

webserver = "/var/www"
key = "keykey1"
path = "/stream"

def main():
    print "################################################"
    print "#                                              #"
    print "#         Welcome to The SPliF Server !        #"
    print "#  SPliF is a Fork from Bulb Security LLC SPF  #"
    print "#                                              #"
    print "################################################"
    print
    print
    app_connect()


def app_connect():
    while True:
        print "\nConnect to a smartphone management app. You will need to supply the phone number,the control key, and the URL path\n"
        number = raw_input('Phone Number (ex: 15555215554): ').strip()
        key = raw_input('Control Key (ex: keykey1): ').strip()
        path = raw_input('App URL Path (ex: /stream): ').strip()

        correct = raw_input("\n\nPhone Number: " + number + "\nControl Key: " + key + "\nURL Path: " + path  + "\nIs this correct?(y/N): ").strip().lower()
        if correct == "y":
            make_files2(path)
            handshake(path,key)
            modemtype = "app"
            break

def handshake(path, key):
    fullpath = webserver + path + "/connect"
    while True:
        f = open(fullpath, 'r+')
        line = f.readline()
        correctstring = key + " CONNECT"
        if line == correctstring:
            command = "\n" + key + " CONNECTED"
            f.write(command)
            f.close()
            print "CONNECTED!\n"
            break
        else:
            f.close()
            time.sleep(1)

def make_files2(path):
    fullpath = webserver + path
    command1 = "mkdir " + fullpath
    os.system(command1)
    command11 = "chmod 777 " + fullpath
    os.system(command11) 
    connectfile = fullpath + "/connect"
    command2 = "touch " + connectfile
    os.system(command2)
    command3 = "chmod 777 " + connectfile
    os.system(command3)
    getfuncfile = fullpath + "/getfunc"
    command6 = "touch " + getfuncfile
    os.system(command6)
    command7 = "chmod 777 " + getfuncfile
    os.system(command7)
    putfuncfile = fullpath + "/putfunc"
    command6 = "touch " + putfuncfile
    os.system(command6)
    command7 = "chmod 777 " + putfuncfile
    os.system(command7)
    connectupload = fullpath + "/connectuploader.php"
    command12 = "touch " + connectupload
    os.system(command12)
    command13 = "chmod 777 " + connectupload
    os.system(command13)    
    connectuploadtext = "<?php\n$base=$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n$file = fopen('connect','wb');\nfwrite($file, $base);\n?>";
    CONNECTFILE = open(connectupload, "w")
    CONNECTFILE.write(connectuploadtext)
    CONNECTFILE.close()
    
if __name__ == '__main__':
    main()
